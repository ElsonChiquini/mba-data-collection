Projeto MBA Data Collection
Ingest√£o e Processamento de Dados no MinIO (Camadas Bronze ‚Üí Silver)

1Ô∏è‚É£ L√≥gica da Solu√ß√£o

A pipeline foi estruturada em duas camadas principais ‚Äî Bronze e Silver ‚Äî armazenadas no MinIO, simulando um Data Lake corporativo.

A camada Bronze guarda os dados no formato mais pr√≥ximo do original (raw).
A camada Silver aplica o tratamento, normaliza√ß√£o e tipagem dos dados, gerando arquivos Parquet prontos para an√°lise.

| Tipo           | Fonte                                                       | Descri√ß√£o                                                                 |
| -------------- | ----------------------------------------------------------- | ------------------------------------------------------------------------- |
| Banco de dados | PostgreSQL (`db_loja`)                                      | Tabelas transacionais simuladas (categorias, clientes, pedidos, produtos) |
| Arquivos JSON  | `json/` local                                               | Dados aninhados de sistemas externos                                      |
| API P√∫blica    | [BrasilAPI - IBGE](https://brasilapi.com.br/api/ibge/uf/v1) | Lista de estados brasileiros (UFs)                                        |

Etapas da Pipeline
Camada Bronze (Raw)

ingest_dbloja.py
Extrai dados do schema db_loja e envia para o bucket data-ingest/bronze/dbloja/ em formato Parquet.
As tabelas categorias_produto, cliente, pedido_cabecalho e pedido_itens s√£o processadas em Full Load, enquanto produto usa ingest√£o incremental.

controle_produto.py
Implementa o controle de marca d‚Äô√°gua (watermark).
O script l√™ o arquivo watermark_produto.txt para saber a √∫ltima data processada (data_atualizacao).
Apenas registros com data_atualizacao maior que a √∫ltima marca s√£o ingeridos.
Ap√≥s a execu√ß√£o, o watermark √© atualizado.

Exemplo de controle:

watermark_produto.txt
2025-11-01T14:10:42


upload_jsons_to_minio.py
Copia os arquivos .json da pasta local para o MinIO com timestamp autom√°tico no nome:

bronze/json/dados_pedidos_20251031_224217.json


ingest_ibge_brasilapi_to_minio.py
Faz o consumo da BrasilAPI (endpoint /ibge/uf/v1) e salva o retorno:

bronze/api/ibge_uf/ibge_uf_data_20251031_224147.json


listar_bronze_minio.py
Lista todos os objetos armazenados na camada Bronze.

Camada Silver (Trusted)

new_script_silver.py
L√™ os Parquets da Bronze e escreve novos Parquets tratados na Silver.
Para produto, √© feito um Merge (Upsert) conforme id_produto, mantendo apenas registros mais recentes.

new_script_silver_json.py
Normaliza os arquivos JSON (explode arrays, trata colunas nulas, cria tabelas auxiliares):

transacoes/
pedidos_externos/
pedidos_externos_itens/
produtos_parceiros/
tags_produtos/


new_script_silver_ibge_final.py
L√™ o JSON da BrasilAPI e aplica schema fixo (id, sigla, nome).

2Ô∏è‚É£ Decis√µes de Design
| Decis√£o                      | Justificativa                                               |
| ---------------------------- | ----------------------------------------------------------- |
| **MinIO como Data Lake**     | Ambiente leve e compat√≠vel com AWS S3                       |
| **Particionamento temporal** | Estrutura `data=YYYYMMDD/` garante hist√≥rico e incremental  |
| **Parquet**                  | Otimiza leitura e compress√£o                                |
| **Watermark local**          | Evita reprocessamento e mant√©m hist√≥rico incremental        |
| **Merge (Upsert)**           | Atualiza registros sem duplica√ß√£o                           |
| **Scripts modulares**        | Execu√ß√£o isolada ou completa via `orchestrator_pipeline.py` |
| **SDK MinIO**                | Facilita leitura e escrita diretas em buckets               |

3Ô∏è‚É£ Execu√ß√£o dos Scripts
üîß Pr√©-requisitos

Python 3.10+

Servidor MinIO ativo (http://localhost:9000)

Bucket data-ingest criado

Instalar depend√™ncias:

pip install -r requirements.txt

Execu√ß√£o Passo a Passo
1Ô∏è‚É£ Ingest√£o Bronze
python script/ingest_dbloja.py
python script/controle_produto.py   # opcional, se banco real estiver conectado
python script/upload_jsons_to_minio.py
python script/ingest_ibge_brasilapi_to_minio.py

2Ô∏è‚É£ Diagn√≥stico
python script/listar_bronze_minio.py

3Ô∏è‚É£ Processamento Silver
python script/new_script_silver.py
python script/new_script_silver_json.py
python script/new_script_silver_ibge_final.py

4Ô∏è‚É£ Pipeline completa
python script/orchestrator_pipeline.py

4Ô∏è‚É£ Evid√™ncias ‚Äî Estrutura Final no MinIO

-------------------------------------------------------------
ü•â Camada Bronze

Estrutura geral da Bronze


Subpasta json/ ‚Äî arquivos extra√≠dos


Subpasta api/ibge_uf/ ‚Äî dados da BrasilAPI


Subpasta dbloja/data="data do upload"/ ‚Äî dados Parquet


Watermark salva ap√≥s execu√ß√£o incremental

ü•à Camada Silver

Estrutura geral do Data Lake


Camada Silver completa (/prata/)


Subpasta ibge_uf


Subpasta dbloja


Subpasta json

Autores:
Cristina Alves
Elson Chiquini
Gabriel Carille

Organiza√ß√£o do Reposit√≥rio

üìÇ /mba-data-collection
‚îú‚îÄ‚îÄ /script/
‚îÇ   ‚îú‚îÄ‚îÄ ingest_dbloja.py
‚îÇ   ‚îú‚îÄ‚îÄ controle_produto.py
‚îÇ   ‚îú‚îÄ‚îÄ upload_jsons_to_minio.py
‚îÇ   ‚îú‚îÄ‚îÄ ingest_ibge_brasilapi_to_minio.py
‚îÇ   ‚îú‚îÄ‚îÄ listar_bronze_minio.py
‚îÇ   ‚îú‚îÄ‚îÄ new_script_silver.py
‚îÇ   ‚îú‚îÄ‚îÄ new_script_silver_json.py
‚îÇ   ‚îú‚îÄ‚îÄ new_script_silver_ibge_final.py
‚îÇ   ‚îî‚îÄ‚îÄ orchestrator_pipeline.py
‚îú‚îÄ‚îÄ /json/
‚îÇ   ‚îî‚îÄ‚îÄ arquivos .json usados como fonte
‚îú‚îÄ‚îÄ /evidencias/
‚îÇ   ‚îî‚îÄ‚îÄ imagens do console MinIO
‚îú‚îÄ‚îÄ requirements.txt
‚îî‚îÄ‚îÄ README.md

```mermaid
flowchart TD
    %% --- ESTILO ---
    classDef bronze fill:#c57f27,stroke:#333,stroke-width:1px,color:#fff,font-weight:bold;
    classDef silver fill:#6b7280,stroke:#333,stroke-width:1px,color:#fff,font-weight:bold;
    classDef optional fill:#94a3b8,stroke:#333,stroke-width:1px,color:#fff;
    classDef orchestrator fill:#047857,stroke:#333,stroke-width:1px,color:#fff,font-weight:bold;

    %% --- FLUXO PRINCIPAL ---
    A[1Ô∏è‚É£ ingest_dbloja.py<br/>(Bronze ‚Äì PostgreSQL)]:::bronze --> 
    B[2Ô∏è‚É£ upload_jsons_to_minio.py<br/>(Bronze ‚Äì JSON)]:::bronze -->
    C[3Ô∏è‚É£ ingest_ibge_brasilapi_to_minio.py<br/>(Bronze ‚Äì API)]:::bronze -->
    D{üíæ Banco real dispon√≠vel?}

    D -->|Sim| E[4Ô∏è‚É£ controle_produto.py<br/>(Bronze ‚Äì Incremental)]:::bronze
    D -->|N√£o| F[5Ô∏è‚É£ listar_bronze_minio.py<br/>(Verifica√ß√£o opcional)]:::optional

    E --> G[6Ô∏è‚É£ new_script_silver.py<br/>(Silver ‚Äì db_loja)]:::silver
    F --> G
    G --> H[7Ô∏è‚É£ new_script_silver_json.py<br/>(Silver ‚Äì JSON)]:::silver
    H --> I[8Ô∏è‚É£ new_script_silver_ibge_final.py<br/>(Silver ‚Äì API)]:::silver

    %% --- ORQUESTRADOR ---
    A -.-> Z[‚öôÔ∏è orchestrator_pipeline.py<br/>(Executa toda a pipeline)]:::orchestrator

